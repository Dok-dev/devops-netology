# Домашнее задание «3.8. Компьютерные сети, лекция 3»

**1 - задание.**
ipvs. Если при запросе на VIP сделать подряд несколько запросов (например, `for i in {1..50}; do curl -I -s 172.28.128.200>/dev/null; done `), ответы будут получены почти мгновенно. Тем не менее, в выводе `ipvsadm -Ln` еще некоторое время будут висеть активные `InActConn`. Почему так происходит?

**Ответ**    
InActConn - это все состояния соединенией кроме ESTABLISHED.   
Для LVS типа DR и LVS-Tun директор не видит пакетов от реального сервера к клиенту. 
А для завершения tcp-соединения происходит отправка FIN с последующим ответом ACK с другого конца.
Затем второй участник посылает свой FIN, за которым следует ACK от первой машины.    
Однако если реальный сервер инициирует прекращение соединения, директор сможет сделать вывод о том, 
что это произошло, только увидев ACK от клиента. Директор вынужден делать вывод, 
что соединение закрыто из частичной информации, и использует свою собственную таблицу тайм-аутов, 
чтобы объявить, что соединение прервано. Таким образом в колонке InActConn могут быть видны
 еще некоторое время соединения как активные.

---

**2 - задание.**
 На лекции мы познакомились отдельно с ipvs и отдельно с keepalived. Воспользовавшись этими знаниями, совместите технологии вместе (VIP должен подниматься демоном keepalived). Приложите конфигурационные файлы, которые у вас получились, и продемонстрируйте работу получившейся конструкции. Используйте для директора отдельный хост, не совмещая его с риалом! Подобная схема возможна, но выходит за рамки рассмотренного на лекции.

**Ответ**    
[Настройка первого директора](netology1.md)    
[Настройка второго директора](netology2.md)    
[Настройка первого хоста](netology3.md)    
[Настройка второго хоста](netology4.md)   

Проверка:    
![2.0](2.0.GIF)

![2.1](2.1.GIF)

Результаты работы:   
![2.2](2.2.GIF)

После выключения первого директора:   
![2.3](2.3.GIF)

---

**3 - задание.**
В лекции мы использовали только 1 VIP адрес для балансировки. У такого подхода несколько отрицательных моментов, один из которых – невозможность активного использования нескольких хостов (1 адрес может только переехать с master на standby). Подумайте, сколько адресов оптимально использовать, если мы хотим без какой-либо деградации выдерживать потерю 1 из 3 хостов при входящем трафике 1.5 Гбит/с и физических линках хостов в 1 Гбит/с? Предполагается, что мы хотим задействовать 3 балансировщика в активном режиме (то есть не 2 адреса на 3 хоста, один из которых в обычное время простаивает).

**Ответ**    
Что бы задействовать 3 балансировщика в активном режиме вероятно понадобится использовать 3 VIP адреса, по одному на каждый балансировщик.
А поочередную выдачу адресов балансировщиков решать на уровне DNS, либо маршрутизацией на anycast.

---

**ОТЗЫВ ПРЕПОДАВАТЕЛЯ**

Петр Шило    
8 марта 2021 17:20

*Здравствуйте, Тимофей.*

*Спасибо за выполненное задание.*
*Все верно.*
*Успехов в дальнейшем прохождении курса.*

